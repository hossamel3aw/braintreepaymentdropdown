<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Braintree Payment</title>
  <style>
    /* Modal overlay styling for a clean centered UI */
    html, body {
      margin: 0; padding: 0;
      background: rgba(0, 0, 0, 0.5);  /* semi-transparent dark background */
      height: 100%;
    }
    body { display: flex; align-items: center; justify-content: center; }
    #modal {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      position: relative;
      text-align: center;
      font-family: Arial, sans-serif;
    }
    #cancel-button {
      position: absolute;
      top: 10px; right: 10px;
      background: none;
      border: none;
      font-size: 24px;
      line-height: 24px;
      cursor: pointer;
    }
    /* Hide the cancel button outline on focus */
    #cancel-button:focus { outline: none; }
    #loading {
      margin: 20px 0;
      font-size: 16px;
    }
    #dropin-container {
      margin: 20px 0;
    }
    #pay-button {
      display: inline-block;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      color: #fff;
      background: #007bff; /* Blue button */
      cursor: pointer;
    }
    #pay-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #result {
      margin: 15px 0 0;
      font-size: 16px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- Modal overlay -->
  <div id="modal">
    <!-- Optional cancel/close button for the modal -->
    <button id="cancel-button" aria-label="Cancel payment">&times;</button>
    <!-- Loading state (shown until Braintree Drop-in is ready) -->
    <div id="loading">Loading payment form...</div>
    <!-- Container for Braintree Drop-in UI (initially hidden until ready) -->
    <div id="dropin-container" style="display:none;"></div>
    <!-- Payment button (shown after Drop-in UI is loaded) -->
    <button id="pay-button" style="display:none;">Pay $1000</button>
    <!-- Area for success/error message -->
    <div id="result"></div>
  </div>

  <!-- Braintree Drop-in JS library (v1.44.1) -->
  <script src="https://js.braintreegateway.com/web/dropin/1.44.1/js/dropin.min.js"></script>
  <script>
    // Configuration: Supabase Edge Function URLs (replace these with your own if needed)
    const tokenUrl = "https://guwzgnjdnchuvypsmzue.supabase.co/functions/v1/generate-client-token";
    const paymentUrl = "https://guwzgnjdnchuvypsmzue.supabase.co/functions/v1/process-payment";
    // Fixed payment amount (USD)
    const paymentAmount = 1000;  // $1000 USD

    // Utility: function to send message back to FlutterFlow parent
    function sendResultMessage(status, detail) {
      // Using window.parent.postMessage to communicate with the parent (FlutterFlow app).
      // We use "*" as targetOrigin for simplicity, meaning any parent can receive. 
      // If you know the specific origin of the parent, use it for better security.
      window.parent.postMessage({ status: status, detail: detail }, "*");
    }

    // Handle the optional cancel button
    document.getElementById("cancel-button").addEventListener("click", () => {
      // Inform parent that the user cancelled the payment
      sendResultMessage("cancelled", "User closed the payment modal");
      // You can additionally close the modal or redirect as needed. In a FlutterFlow WebView, 
      // the parent app might handle closing the WebView upon receiving this message.
    });

    // Initialize Braintree Drop-in after fetching the client token
    async function startBraintreeDropin() {
      try {
        // 1. Fetch the client token from Supabase Edge Function
        const tokenResponse = await fetch(tokenUrl, { method: "GET" });
        if (!tokenResponse.ok) {
          throw new Error("Unable to fetch client token (HTTP " + tokenResponse.status + ")");
        }
        const tokenData = await tokenResponse.json();
        const clientToken = tokenData.clientToken;  // The client token string from your server

        // 2. Create the Drop-in UI instance with the client token
        const dropinInstance = await braintree.dropin.create({
          authorization: clientToken,
          container: "#dropin-container",
          // Only include card and PayPal options, excluding Apple Pay and Google Pay:
          // Payment options omitted from this list will not be offered to the customer&#8203;:contentReference[oaicite:2]{index=2}.
          paymentOptionPriority: ["card", "paypal"],
          // PayPal configuration (only needed if PayPal is enabled on your Braintree account):
          paypal: {
            flow: "checkout",            // "checkout" flow for one-time payments
            amount: paymentAmount,       // transaction amount
            currency: "USD"              // currency code
            // Additional PayPal options (like intent) can be added here if needed
          }
        });
        // Note: Ensure PayPal is enabled in your Braintree Control Panel and linked to a PayPal sandbox account for testing&#8203;:contentReference[oaicite:3]{index=3}.

        // 3. Drop-in is ready – show the payment form and button, hide the loading message
        document.getElementById("dropin-container").style.display = "block";
        document.getElementById("pay-button").style.display = "inline-block";
        document.getElementById("loading").style.display = "none";

        // 4. Handle the Pay button click to request payment method and process the payment
        document.getElementById("pay-button").addEventListener("click", async () => {
          // Disable the Pay button to prevent multiple clicks and show processing state
          const payButton = document.getElementById("pay-button");
          payButton.disabled = true;
          document.getElementById("result").textContent = "Processing payment...";

          try {
            // Request a payment method nonce from Drop-in (this pops up PayPal flow if PayPal selected)
            const { nonce, type } = await dropinInstance.requestPaymentMethod();
            // We have a nonce that represents the payment details (card or PayPal).
            // Now send this nonce to our server to actually process the transaction.
            const paymentResponse = await fetch(paymentUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                paymentMethodNonce: nonce,
                amount: paymentAmount  // It's a good idea for the server to use its own fixed amount too
              })
            });
            const paymentResult = await paymentResponse.json();
            // Expecting paymentResult to have a field like success or error based on server implementation.
            if (paymentResult.success) {
              // Payment successful
              document.getElementById("result").textContent = "✅ Payment successful!";
              sendResultMessage("success", "Payment completed successfully");
            } else {
              // Payment failed (e.g., transaction declined or error)
              const errorMsg = paymentResult.error || "Payment failed";
              document.getElementById("result").textContent = "❌ " + errorMsg;
              sendResultMessage("failure", errorMsg);
            }
          } catch (err) {
            console.error("Payment error:", err);
            document.getElementById("result").textContent = "❌ Payment failed: " + err.message;
            sendResultMessage("failure", err.message || "Payment failed");
          } finally {
            // Re-enable the Pay button (in case the user wants to retry)
            payButton.disabled = false;
          }
        });
      } catch (error) {
        console.error("Drop-in initialization error:", error);
        // Show an error state to the user
        document.getElementById("loading").textContent = "Error loading payment form.";
        // Inform the parent about the error
        sendResultMessage("error", error.message || "Drop-in initialization failed");
      }
    }

    // Start the payment UI logic
    startBraintreeDropin();
  </script>

  <!-- 
    Developer Notes:
    - Ensure your Supabase Edge Functions have proper CORS headers so that this HTML (served from a different domain like GitHub Pages) can call them. 
      In your Edge Function code, you should add `Access-Control-Allow-Origin: *` (and other CORS headers) to the response. 
      For example, in Deno (Supabase) you might do:
         if (req.method === "OPTIONS") {
           return new Response(null, { status: 204, headers: { ...corsHeaders } });
         }
         // and for actual response:
         return new Response(JSON.stringify({ clientToken }), { headers: { ...corsHeaders, "Content-Type": "application/json" } });
      where corsHeaders includes `"Access-Control-Allow-Origin": "*"`&#8203;:contentReference[oaicite:4]{index=4}&#8203;:contentReference[oaicite:5]{index=5}. 
      This ensures the browser doesn’t block the requests due to the same-origin policy.
    - Security: The amount is hard-coded in this client for simplicity. In practice, your server (process-payment function) should **not** rely on the client to specify the amount (to prevent tampering). It’s best to fix the amount server-side or verify it rigorously.
    - Braintree Sandbox Testing: Use the following test credentials in **Sandbox** mode:
         • **Test credit cards:** e.g., 4111 1111 1111 1111 (Visa) with any future expiration and any CVV will simulate a successful charge&#8203;:contentReference[oaicite:6]{index=6}&#8203;:contentReference[oaicite:7]{index=7}. 
           Card number 4000 1111 1111 1115 (Visa) will simulate a processor decline response&#8203;:contentReference[oaicite:8]{index=8} (useful for testing failure paths).
         • **Test transaction amounts:** In the Braintree sandbox, transactions of $2000.00 or higher will be **declined** by the gateway for testing purposes&#8203;:contentReference[oaicite:9]{index=9}. Our example uses $1000, which is below that threshold and should succeed with a valid test card. If you want to test a failure scenario, you could temporarily change the amount to $2000 (and ensure the server function uses that) to trigger a decline.
         • **Test PayPal:** To test PayPal in sandbox, you need to have PayPal enabled in Braintree and link a **Sandbox PayPal** account to your Braintree sandbox account&#8203;:contentReference[oaicite:10]{index=10}. When you click the PayPal option in the Drop-in UI, a sandbox PayPal login window will appear. Use your sandbox buyer credentials to simulate a PayPal payment.
    - Deployment: This file is ready to be hosted on a static site (e.g., GitHub Pages). Simply upload it and ensure the URL to this HTML is used in your FlutterFlow WebView (or wherever it’s embedded). No environment variables are needed, since all keys and tokens are handled via the Supabase functions.
  -->
</body>
</html>
