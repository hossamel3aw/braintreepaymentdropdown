<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Payment Gateway</title>
  <style>
    /* [KEEP EXISTING STYLES] */
  </style>
</head>
<body>
  <div id="modal">
    <button id="cancel-button" aria-label="Cancel payment">&times;</button>
    <div id="loading">Initializing payment system...</div>
    <div id="dropin-container" style="display:none;"></div>
    <button id="pay-button" style="display:none;">Pay $1000</button>
    <div id="result"></div>
  </div>

  <!-- CHANGED: Updated to latest Braintree version -->
  <script src="https://js.braintreegateway.com/web/dropin/1.44.1/js/dropin.min.js"></script>
  
  <script>
    // ========== MUST CHANGE THESE ========== //
    const tokenUrl = "https://guwzgnjdnchuvypsmzue.supabase.co/functions/v1/generate-client-token";
    const paymentUrl = "https://guwzgnjdnchuvypsmzue.supabase.co/functions/v1/process-payment";
    const supabaseAnonKey = "ee49000c68f7fd3d4af2ceb0b44bb0125a1d0c18d793b91cdd5481a595c7e4de"; // Get from Supabase Dashboard
    // ======================================== //

    const paymentAmount = 1000.00; // USD

    function sendResultMessage(status, detail) {
      window.parent.postMessage({ 
        type: 'paymentResult',
        status: status,
        detail: detail 
      }, "*");
    }

    document.getElementById("cancel-button").addEventListener("click", () => {
      sendResultMessage("cancelled", "User cancelled payment");
      // Optional: Add code to close modal if needed
    });

    async function startBraintreeDropin() {
      try {
        // Added authorization header
        const tokenResponse = await fetch(tokenUrl, { 
          method: "GET",
          headers: {
            "Authorization": `Bearer ${ee49000c68f7fd3d4af2ceb0b44bb0125a1d0c18d793b91cdd5481a595c7e4de}`,
            "Content-Type": "application/json"
          }
        });

        if (!tokenResponse.ok) {
          throw new Error(`Token error: ${tokenResponse.status}`);
        }

        const tokenData = await tokenResponse.json();
        
        // Added validation
        if (!tokenData.clientToken) {
          throw new Error("Invalid client token format");
        }

        const dropinInstance = await braintree.dropin.create({
          authorization: tokenData.clientToken,
          container: "#dropin-container",
          paymentOptionPriority: ["card", "paypal"],
          paypal: {
            flow: "checkout",
            amount: paymentAmount,
            currency: "USD"
          },
          card: {
            overrides: {
              styles: {
                input: {
                  "font-size": "16px",
                  "color": "#333"
                }
              }
            }
          }
        });

        // UI Updates
        document.getElementById("dropin-container").style.display = "block";
        document.getElementById("pay-button").style.display = "inline-block";
        document.getElementById("loading").style.display = "none";

        document.getElementById("pay-button").addEventListener("click", async () => {
          const payButton = document.getElementById("pay-button");
          payButton.disabled = true;
          document.getElementById("result").textContent = "Processing...";

          try {
            const { nonce } = await dropinInstance.requestPaymentMethod();
            
            // Added authorization header
            const paymentResponse = await fetch(paymentUrl, {
              method: "POST",
              headers: { 
                "Content-Type": "application/json",
                "Authorization": `Bearer ${ee49000c68f7fd3d4af2ceb0b44bb0125a1d0c18d793b91cdd5481a595c7e4de}`
              },
              body: JSON.stringify({
                paymentMethodNonce: nonce,
                amount: paymentAmount
              })
            });

            const paymentResult = await paymentResponse.json();
            
            if (paymentResult.success) {
              sendResultMessage("success", {
                transactionId: paymentResult.id,
                amount: paymentAmount
              });
              document.getElementById("result").textContent = "Payment Successful!";
            } else {
              throw new Error(paymentResult.error || "Payment failed");
            }
          } catch (err) {
            console.error("Payment error:", err);
            document.getElementById("result").textContent = err.message;
            sendResultMessage("error", err.message);
          } finally {
            payButton.disabled = false;
          }
        });
      } catch (error) {
        console.error("Initialization error:", error);
        document.getElementById("loading").textContent = "Initialization Failed";
        sendResultMessage("error", error.message);
      }
    }

    startBraintreeDropin();
  </script>
</body>
</html>
