<!DOCTYPE html>
<html>
  <head>
    <title>Braintree Drop-in Test</title>
    <script src="https://js.braintreegateway.com/web/dropin/1.40.1/js/dropin.min.js"></script>
    <style>
      body { font-family: sans-serif; padding: 2rem; }
      #dropin-container { margin-bottom: 1rem; }
    </style>
  </head>
  <body>
    <h2>Pay $1000</h2>
    <div id="dropin-container"></div>
    <button id="submit-button">Pay</button>

    <script>
      // STEP 1: Get client token from Supabase
      fetch("https://guwzgnjdnchuvypsmzue.supabase.co/functions/v1/generate-client-token")
        .then(res => res.json())
        .then(data => {
          braintree.dropin.create({
            authorization: data.clientToken,
            container: "#dropin-container",
            paypal: { flow: 'vault' },
            googlePay: {
              googlePayVersion: 2,
              merchantId: 'jmj746j7dm3r9kyy', // Use your real Google merchant ID for production
              transactionInfo: {
                totalPriceStatus: 'FINAL',
                totalPrice: '1000.00',
                currencyCode: 'USD'
              }
            }
          }, (err, dropinInstance) => {
            if (err) {
              console.error("Dropin Error:", err);
              return;
            }

            document.getElementById("submit-button").addEventListener("click", () => {
              dropinInstance.requestPaymentMethod((err, payload) => {
                if (err) {
                  console.error("Payment Method Error:", err);
                  return;
                }

                // STEP 2: Send nonce to Supabase to process payment
                fetch("https://guwzgnjdnchuvypsmzue.supabase.co/functions/v1/process-payment", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ paymentMethodNonce: payload.nonce })
                })
                .then(res => res.json())
                .then(result => {
                  if (result.success) {
                    alert("Payment successful! Transaction ID: " + result.transactionId);
                  } else {
                    alert("Payment failed: " + (result.error || "Unknown error"));
                  }
                });
              });
            });
          });
        });
    </script>
  </body>
</html>

